#!/bin/bash
# Ensure Nginx is installed (skip if already installed)

if ! command -v nginx &> /dev/null
then
    echo "Nginx is not installed. Installing Nginx..."
    apt-get update
    apt-get install -y nginx
fi

# Update Nginx configuration to run as 'nginx' user and listen on port 8080
NGINX_CONF="/etc/nginx/nginx.conf"

# Modify the user directive
sed -i 's/^user .*/user nginx;/' $NGINX_CONF

# Modify the listen directive to use port 8080
sed -i 's/listen 80 default_server;/listen 8080 default_server;/' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80 default_server;/listen \[::\]:8080 default_server;/' /etc/nginx/sites-available/default

# Ensure Nginx is running as 'nginx' user
chown -R nginx:nginx /var/log/nginx
chown -R nginx:nginx /var/lib/nginx
chown -R nginx:nginx /var/www/html

# Restart Nginx to apply changes
systemctl restart nginx

# Verify Nginx is running as 'nginx' user and listening on port 8080
echo "Verifying Nginx configuration..."
ps aux | grep [n]ginx
nc -zv 0 8080 && echo "Nginx is running and listening on port 8080"
